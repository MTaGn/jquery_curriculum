<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      

      // 楽天ブックスの総合検索APIを使って製作してください。
      // answerの挙動を良く見てね！
      //
      // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
      // https://webservice.rakuten.co.jp/api/bookstotalsearch/
      //
      //
      // [使うメソッド]
      // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
      // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
      // 以下は今回使う$.ajaxの基本的な形です。
      // 自分のコメント api ソフトの機能を共有させるもの。開発の効率化 ajax 非同期通信。データのリクエストでデータをもらう。json ファイル形式。 get post
      // 自分のコメント 1.ajaxでほしい情報をリクエストできるようにhits,page,keywordを設定
      // 自分のコメント 2.アプリに検索ワードを入れてクリックすると、そのワードを取得、
      // 自分のコメント 3.doneで取得したものを表示する

      // 自分のコメント 
      $(function() {
        var pageNum = 1;
        var preWord = "";
        //自分のコメント 一番最初は検索されていないはずだから、空でelseの処理に持っていく。
        //自分のコメント if文自分のコメント で1.同ワードが複数回検索されたときはページ数が増える、2.新しいワードが検索されると、前の検索結果を消去、1ページのみ表示させる
        $(".search__btn").click(click);
        function click() {
          var word = $(".search__text__input").val();
          if(word == preWord) {
            pageNum++;
            }else{
            $(".lists").empty();
            pageNum = 1;
            preWord = word;　
          }
          // 楽天ブックスにリクエストしてkeywordに応じたデータをgetメソッドでもってくる。keyにhits:20, page:変数, keyword:変数を設定。
          $.ajax({
            url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
            type: 'GET',
            //json ファイル形式
            datatype: 'json',
            data: { //出力パラメータ:楽天側が用意してくれる内容なので、こちらは入力必要なし}
            // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
              applicationId: '1019399324990976605', // (今回はこのIDを使用してください)
              booksGenreId: '001',
              // hits 1ページ当たりのデータ件数
              hits: '20',
              // pageは変数にして、検索結果によって変化するように設定
              page: pageNum,
              // wordは変数にして、inputにて格納された検索ワードを渡している
              keyword: word
          },//.data
         
          // done() 通信が成功した場合、fail() 通信が失敗した場合の関数を実行
          }).done(done).fail(failor);
          //done() dataという引数に取得したデータが格納されている  
          function done(data) {
          console.log(data);
          //ifで検索結果が1件以上ある場合は画像と作品名、著者名、出版社名を表示し、0件の場合は検索結果がないことを表示。    
            if(data.Items.length > 0) {
              var books = "";
              //each()にて本のtitle等を1件ずつ取得してbooksに格納、連結していく。 
              $.each(data.Items, function(index, value) {

                var title = value.Item.title;
                var author = value.Item.author;
                var publisherName = value.Item.publisherName;
                var largeImageUrl = value.Item.largeImageUrl;
                
                  //自分のコメント data配列のItems配列のItemオブジェクトのtitle keyにてtatleを取得。[index]はヒット数取得するため。              
                  // $.ajaxによってデータが取得できたら、必要なデータ(作品名とか作者名とか)を取得します。
                  // 取得できたらHTMLに<ul class='lists'></ul>を用意しているので、その中に下のテンプレに沿ってデータを入れ込みましょう。
                  // eachで20件取得、配列にいれて降順に、prependでindexの多いほうが先に表示されるので0-19の順に表示
                  // 現状の表示結果 prependで←2 ←1 ←0 の順に追加され、次の20件も同じように追加されている。
                  // 1.最初の20件の1ブロック内では←17 ←18 ←19の順に追加。次のブロック自体はprependで←ブロック2 ←ブロック1の順に。
                  // 2.追加するhtmlは次の20件が上に入るように2ページ目以降は<ul class="addList">を追加してその中にappendしていく。⇒×　同じ20件のデータが表示される
                  // 3.取得オブジェクトを配列に格納して、配列を逆順にしてeachで表示
                  // 4.eachの中で20個li要素を作って、文字列としてprependで表示させる。変数に代入して変数を全部足して、最後にprepend
                books += (
                "<li class='lists__item'>"+ index +
                "<div class='lists__item__inner'>"+
                  "<a href='' class='lists__item__link' target='_blank'>"+
                    "<img src='"+largeImageUrl+"' class='lists__item__img' alt=''>"+
                    "<p class='lists__item__detail'>作品名："+title+"</p>"+
                    "<p class='lists__item__detail'>作者　："+author+"</p>"+
                    "<p class='lists__item__detail'>出版社："+publisherName+"</p>"+
                  "</a>"+
                "</div>"+
                "</li>"
                );//books
              });//each
          // prepend()にて20件のデータを.listsの要素の中に格納する
              $(".lists").prepend(books);
              }else{
                $(".lists").prepend("<div class=message>検索結果が見つかりませんでした。\n別のキーワードで検索して下さい。</div>");
              }//doneの中のif
        }//doneのfunction
        // dataオブジェクトのresponsejsonオブジェクトのerror keyからerrorの内容を取得
          function failor(data) {
            if( data.readyState !== 0) {
              console.log('data > 0');
            var error = data.responseJSON.error;
            var description = data.responseJSON.error_description;
            alert(error+"\n"+description);
            }else{
              console.log('elseの中');
              alert("ERR_INTERNET_DISCONNECTED");
            }//failorのif
          }//fail
        }//click
      });//最初のfunction
    </script>
  </body>
</html>


<!-- review1 click、done、fail等は長くなると見ずらいので関数として外に出す。表示データは配列の若い順から表示する。変数iは意味のある名前に。 -->
<!--自分のコメント eachで回すからfor, ifいらん。eqで同じところ指定している。valueがさすもの。,で区切ると縦に並ぶ。+でつなぐと横に？  -->
<!--自分のコメント 条件1.検索結果が20件表示される。さらに同じワードで検索をかけると最初の20件の上に次の20件が表示。-->
<!--自分のコメント 条件2.別のワードにすると前の結果は消去され、新たに20件が表示。-->
<!--自分のコメント 条件3.検索結果0件のとき、【検索結果が見つかりませんでした。別のキーワードで検索して下さい。】を表示。-->
<!--自分のコメント 徐健4.正常に通信ができる場合 → 検索結果表示、できない場合 → どんなエラーが起きてどうすればよいのか表示(1.検索ワード無 2.半角英数字1文字 3.検索連打 4.ネット切断)。 -->
<!--自分のコメント 関数はまとめて書く。定義をしておく。-->
<!--自分のコメ})ント ページのひな形があるから登録はすんでるはず  -->
<!--自分のコメント .done(function(){})正常終了したら実行する。 .fail(function(){}) 　リクエストして通信が終了したら実行するときに使う？サービス固有パラメータ？dataにhits20を記述？-->
<!--自分のコメント 検索欄にて入力された値を引数にて getメソッドで楽天urlにリクエストする？(inputタグからval()で受け取れる？)⇒リクエストurlを設定⇒結果を受け取り、空でなければ出力。getメソッドの第二引数に記述。もしデータ数が0より多ければeachで順番に。a, imgタグを追加するかんじ？ --> 
<!-- 自分のコメント 通信が正常でないときでネットにつながっていないとか、1文字検索のときと分岐する。readyStateのkeyで可能。 -->